#!/bin/bash
# Lock UFW down to Tailscale-only inbound access.
# Safe to run multiple times.

set -Eeuo pipefail

log_info() { echo "[ufw-tailscale-lockdown] $*"; }
log_warn() { echo "[ufw-tailscale-lockdown] WARNING: $*" >&2; }
log_error() { echo "[ufw-tailscale-lockdown] ERROR: $*" >&2; }

as_root() {
  if [[ ${EUID:-$(id -u)} -eq 0 ]]; then
    "$@"
  else
    sudo "$@"
  fi
}

backend_state() {
  if ! command -v tailscale &>/dev/null; then
    echo "NotInstalled"
    return 0
  fi

  if command -v python3 &>/dev/null; then
    tailscale status --json 2>/dev/null | python3 -c 'import sys,json; print(json.load(sys.stdin).get("BackendState","Unknown"))' 2>/dev/null || echo "Unknown"
    return 0
  fi

  echo "Unknown"
}

main() {
  state=$(backend_state)
  if [[ "$state" != "Running" ]]; then
    log_warn "Tailscale is not connected (BackendState=$state)"
    log_info "Authenticate first: tailscale up --ssh"
    exit 1
  fi

  if ! command -v ufw &>/dev/null; then
    log_info "UFW not found, installing..."
    if command -v apt &>/dev/null; then
      as_root apt update -qq
      as_root apt install -y ufw
    elif command -v pacman &>/dev/null; then
      as_root pacman -S --noconfirm ufw
    else
      log_error "Cannot install UFW: unknown package manager"
      exit 1
    fi
  fi

  log_info "Setting UFW defaults (deny incoming, allow outgoing)"
  as_root ufw default deny incoming
  as_root ufw default allow outgoing

  log_info "Allowing all inbound on tailscale0"
  as_root ufw allow in on tailscale0

  log_info "Allowing 41641/udp (Tailscale WireGuard)"
  as_root ufw allow 41641/udp

  log_info "Enabling UFW"
  as_root ufw --force enable

  log_info "Done. Current status:"
  as_root ufw status verbose
}

main "$@"
