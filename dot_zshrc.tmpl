# ~/.zshrc - Zsh configuration
# Managed by chezmoi - do not edit directly

# If not running interactively, don't do anything
[[ $- != *i* ]] && return

# ==============================================================================
# PATH Configuration
# ==============================================================================

# Local binaries
[[ -d "$HOME/.local/bin" ]] && export PATH="$HOME/.local/bin:$PATH"
[[ -d "$HOME/bin" ]] && export PATH="$HOME/bin:$PATH"

# Go
if [[ -d "$HOME/go" ]]; then
    export GOPATH="$HOME/go"
    export PATH="$GOPATH/bin:$PATH"
fi

# Bun
[[ -d "$HOME/.bun/bin" ]] && export PATH="$HOME/.bun/bin:$PATH"
[[ -d "$HOME/.cache/.bun/bin" ]] && export PATH="$HOME/.cache/.bun/bin:$PATH"

# Foundry (Ethereum development)
[[ -d "$HOME/.foundry/bin" ]] && export PATH="$HOME/.foundry/bin:$PATH"
[[ -d "$HOME/.config/.foundry/bin" ]] && export PATH="$HOME/.config/.foundry/bin:$PATH"

# pnpm
if [[ -d "$HOME/.local/share/pnpm" ]]; then
    export PNPM_HOME="$HOME/.local/share/pnpm"
    case ":$PATH:" in
        *":$PNPM_HOME:"*) ;;
        *) export PATH="$PNPM_HOME:$PATH" ;;
    esac
fi

# Corepack shims
[[ -d "$HOME/.cache/corepack/shims" ]] && export PATH="$HOME/.cache/corepack/shims:$PATH"

# Opencode
[[ -d "$HOME/.opencode/bin" ]] && export PATH="$HOME/.opencode/bin:$PATH"

# Agents (skills and scripts)
[[ -d "$HOME/.agents/bin" ]] && export PATH="$HOME/.agents/bin:$PATH"

# ==============================================================================
# Environment Variables
# ==============================================================================

export EDITOR="${EDITOR:-nvim}"
export VISUAL="${VISUAL:-nvim}"
export PAGER="${PAGER:-less}"
export LANG="${LANG:-en_US.UTF-8}"

# Enable eza for opencode if available
command -v eza &>/dev/null && export OPENCODE_ENABLE_EXA=true

# ==============================================================================
# Password Store (pass) Configuration
# ==============================================================================

# Set password store directory if it exists
if [[ -d "$HOME/.password-store" ]]; then
    export PASSWORD_STORE_DIR="$HOME/.password-store"
elif [[ -d "$HOME/.local/share/pass" ]]; then
    export PASSWORD_STORE_DIR="$HOME/.local/share/pass"
fi

# ==============================================================================
# Omarchy / Desktop Integration
# ==============================================================================

{{ if eq .mode "desktop" -}}
# Desktop mode: Source Omarchy defaults if available
if [[ -f "$HOME/.local/share/omarchy/default/zsh/rc" ]]; then
    source "$HOME/.local/share/omarchy/default/zsh/rc"
elif [[ -f "$HOME/.local/share/omarchy/default/bash/rc" ]]; then
    # Fallback to bash rc if zsh-specific doesn't exist
    source "$HOME/.local/share/omarchy/default/bash/rc"
fi
{{ end -}}

# ==============================================================================
# Shell Configuration
# ==============================================================================

# History configuration
HISTFILE="${HISTFILE:-$HOME/.zsh_history}"
HISTSIZE=50000
SAVEHIST=50000
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_SPACE
setopt HIST_VERIFY
setopt SHARE_HISTORY
setopt EXTENDED_HISTORY
setopt INC_APPEND_HISTORY

# Directory navigation
setopt AUTO_CD
setopt AUTO_PUSHD
setopt PUSHD_IGNORE_DUPS
setopt PUSHD_SILENT

# Completion
setopt COMPLETE_IN_WORD
setopt ALWAYS_TO_END
autoload -Uz compinit && compinit

# Misc options
setopt INTERACTIVE_COMMENTS
setopt NO_BEEP

# ==============================================================================
# Key Bindings
# ==============================================================================

# Use emacs-style key bindings
bindkey -e

# Better history search
bindkey '^[[A' history-search-backward
bindkey '^[[B' history-search-forward
bindkey '^R' history-incremental-search-backward

# ==============================================================================
# Source Shared Configuration
# ==============================================================================

# Source shared aliases
[[ -f "$HOME/.config/shell/aliases.sh" ]] && source "$HOME/.config/shell/aliases.sh"

# Source shared functions
[[ -f "$HOME/.config/shell/functions.sh" ]] && source "$HOME/.config/shell/functions.sh"

# ==============================================================================
# Load Secrets from Pass
# ==============================================================================

# Load environment secrets from pass if available
# Create a pass entry at 'dev/shell' with KEY=VALUE pairs to auto-load secrets
if command -v pass &>/dev/null && [[ -n "${PASSWORD_STORE_DIR:-}" ]]; then
    # Load shell environment variables
    if [[ -f "$PASSWORD_STORE_DIR/dev/shell.gpg" ]]; then
        passenv "dev/shell"
    fi

    # Load API keys
    if [[ -f "$PASSWORD_STORE_DIR/ai/api-keys.gpg" ]]; then
        passenv "ai/api-keys"
    fi
fi

# ==============================================================================
# Tool Initialization
# ==============================================================================

# Initialize zoxide (smart cd) if available
if command -v zoxide &>/dev/null; then
    eval "$(zoxide init zsh)"
fi

# Initialize fzf if available
if command -v fzf &>/dev/null; then
    # Source fzf keybindings and completion
    [[ -f /usr/share/fzf/key-bindings.zsh ]] && source /usr/share/fzf/key-bindings.zsh
    [[ -f /usr/share/fzf/completion.zsh ]] && source /usr/share/fzf/completion.zsh
    # Arch Linux paths
    [[ -f /usr/share/fzf/fzf-key-bindings.zsh ]] && source /usr/share/fzf/fzf-key-bindings.zsh
fi

# Initialize direnv if available
if command -v direnv &>/dev/null; then
    eval "$(direnv hook zsh)"
fi

# Initialize starship prompt
if command -v starship &>/dev/null; then
    eval "$(starship init zsh)"
fi

# ==============================================================================
# Local Overrides
# ==============================================================================

# Source local zshrc if it exists (for machine-specific config)
[[ -f "$HOME/.zshrc.local" ]] && source "$HOME/.zshrc.local"
