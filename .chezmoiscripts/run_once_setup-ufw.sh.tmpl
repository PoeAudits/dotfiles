#!/bin/bash
# Chezmoi run_once script: Setup UFW firewall for Tailscale-only access
# Server-only: configures UFW to deny all incoming traffic except
# on the Tailscale interface (tailscale0).

{{ if ne .mode "server" -}}
# Not a server, skip
exit 0
{{ end -}}

set -Eeuo pipefail

# ============================================================================
# Logging
# ============================================================================

log_info() { echo "[UFW Setup] $*"; }
log_warn() { echo "[UFW Setup] WARNING: $*" >&2; }
log_error() { echo "[UFW Setup] ERROR: $*" >&2; }

# ============================================================================
# Main
# ============================================================================

main() {
    log_info "Configuring UFW firewall..."

    # Only lock down to Tailscale once the machine is connected.
    if ! command -v tailscale &>/dev/null; then
        log_warn "Tailscale not installed yet; skipping UFW lock-down"
        log_info "After installing/authenticating Tailscale, re-run: chezmoi apply"
        log_info "Or run later: ufw-tailscale-lockdown"
        exit 0
    fi

    backend_state=$(tailscale status --json 2>/dev/null | python3 -c "import sys,json; print(json.load(sys.stdin).get('BackendState','Unknown'))" 2>/dev/null || echo "Unknown")
    if [[ "$backend_state" != "Running" ]]; then
        log_warn "Tailscale not connected yet (BackendState=$backend_state); skipping UFW lock-down"
        log_info "Authenticate first: tailscale up --ssh"
        log_info "Then run: ufw-tailscale-lockdown"
        exit 0
    fi

    as_root() {
        if [[ ${EUID:-$(id -u)} -eq 0 ]]; then
            "$@"
        else
            sudo "$@"
        fi
    }

    # Install ufw if not present
    if ! command -v ufw &>/dev/null; then
        log_info "Installing UFW..."
        if command -v apt &>/dev/null; then
            as_root apt update -qq
            as_root apt install -y ufw
        elif command -v pacman &>/dev/null; then
            as_root pacman -S --noconfirm ufw
        else
            log_error "Cannot install UFW: unknown package manager"
            exit 1
        fi
    fi

    # Reset to defaults (deny incoming, allow outgoing)
    log_info "Setting default policies..."
    as_root ufw default deny incoming
    as_root ufw default allow outgoing

    # Allow all traffic on the Tailscale interface
    log_info "Allowing traffic on tailscale0 interface..."
    as_root ufw allow in on tailscale0

    # Allow Tailscale UDP port (41641) on all interfaces
    # This is needed for Tailscale to establish direct connections
    log_info "Allowing Tailscale WireGuard port (41641/udp)..."
    as_root ufw allow 41641/udp

    # Enable UFW (non-interactive)
    log_info "Enabling UFW..."
    as_root ufw --force enable

    # Show status
    echo ""
    log_info "UFW status:"
    as_root ufw status verbose
    echo ""

    log_info "Firewall configured: all incoming denied except Tailscale"
    log_info ""
    log_info "Important: SSH is NOT allowed from the public internet."
    log_info "Access this server only via Tailscale."
}

main "$@"
