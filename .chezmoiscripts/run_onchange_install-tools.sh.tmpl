#!/bin/bash
# Chezmoi run_onchange script: Install tools from tools.yaml
# This script re-runs whenever tools.yaml changes (hash in comment below)
#
# tools.yaml hash: {{ include "tools.yaml" | sha256sum }}

set -Eeuo pipefail

# Avoid interactive prompts during package installation
export DEBIAN_FRONTEND=noninteractive
export TZ=UTC

# ============================================================================
# Configuration
# ============================================================================

CHEZMOI_SOURCE="{{ .chezmoi.sourceDir }}"
TOOLS_FILE="$CHEZMOI_SOURCE/tools.yaml"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Track what was installed
declare -a INSTALLED_TOOLS=()
declare -a SKIPPED_TOOLS=()
declare -a FAILED_TOOLS=()

# ============================================================================
# Logging Functions
# ============================================================================

log_info() {
    echo -e "${BLUE}[Tools]${NC} $*"
}

log_success() {
    echo -e "${GREEN}[Tools]${NC} $*"
}

log_warn() {
    echo -e "${YELLOW}[Tools]${NC} WARNING: $*" >&2
}

log_error() {
    echo -e "${RED}[Tools]${NC} ERROR: $*" >&2
}

log_skip() {
    echo -e "${GREEN}✓${NC} $1 (already installed)"
}

log_install() {
    echo -e "${YELLOW}→${NC} Installing $1..."
}

# ============================================================================
# OS Detection
# ============================================================================

detect_os() {
    if [[ -f /etc/os-release ]]; then
        # shellcheck source=/dev/null
        source /etc/os-release
        case "$ID" in
            arch|manjaro|endeavouros)
                echo "arch"
                ;;
            ubuntu|debian|pop|linuxmint)
                echo "ubuntu"
                ;;
            *)
                log_warn "Unknown distro: $ID, treating as ubuntu-like"
                echo "ubuntu"
                ;;
        esac
    elif command -v pacman &>/dev/null; then
        echo "arch"
    elif command -v apt &>/dev/null; then
        echo "ubuntu"
    else
        log_error "Cannot detect OS type"
        exit 1
    fi
}

# ============================================================================
# System Dependencies
# ============================================================================

# Ensure required system utilities are installed
ensure_system_dependencies() {
    local os="$1"
    local missing_deps=()
    
    # Check for required utilities (commands only, not packages)
    command -v curl &>/dev/null || missing_deps+=("curl")
    command -v unzip &>/dev/null || missing_deps+=("unzip")
    command -v tar &>/dev/null || missing_deps+=("tar")
    command -v git &>/dev/null || missing_deps+=("git")
    
    # Check if we need to install anything
    local need_install=false
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        log_info "Missing utilities: ${missing_deps[*]}"
        need_install=true
    elif [[ "$os" != "arch" ]] && ! dpkg -s ca-certificates &>/dev/null 2>&1; then
        # Check ca-certificates on Debian-based systems only (use dpkg -s not -l)
        log_info "Missing package: ca-certificates"
        need_install=true
    fi
    
    if [[ "$need_install" == "true" ]]; then
        log_info "Installing system dependencies..."
        
        if [[ "$os" == "arch" ]]; then
            # On Arch, only install what we need (ca-certificates is usually present)
            sudo pacman -S --noconfirm --needed curl unzip tar git || {
                log_error "Failed to install system dependencies"
                return 1
            }
        else
            # Ubuntu/Debian
            sudo apt update -qq || {
                log_error "Failed to update package lists"
                return 1
            }
            sudo apt install -y curl unzip tar git ca-certificates || {
                log_error "Failed to install system dependencies"
                return 1
            }
        fi
        
        log_success "System dependencies installed"
    else
        log_info "System dependencies already installed"
    fi
}

# ============================================================================
# YAML Parsing (using Python - available on all systems)
# ============================================================================

# Python script for YAML parsing - embedded for portability
YAML_PARSER='
import sys
import yaml

def main():
    if len(sys.argv) < 3:
        print("Usage: yaml_parser.py <file> <command> [args...]", file=sys.stderr)
        sys.exit(1)
    
    yaml_file = sys.argv[1]
    command = sys.argv[2]
    
    with open(yaml_file) as f:
        data = yaml.safe_load(f)
    
    tools = data.get("tools", {})
    
    if command == "list":
        # List all tool names
        for name in tools.keys():
            print(name)
    
    elif command == "check":
        # Get check command for a tool
        tool = sys.argv[3]
        check = tools.get(tool, {}).get("check", "")
        print(check if check else "")
    
    elif command == "install":
        # Get install command for a tool and OS
        tool = sys.argv[3]
        os_type = sys.argv[4]
        install = tools.get(tool, {}).get("install", {})
        # Try OS-specific first, then fall back to "all"
        cmd = install.get(os_type, "") or install.get("all", "")
        print(cmd if cmd else "")

if __name__ == "__main__":
    main()
'

# Ensure Python with YAML support is available
ensure_python_yaml() {
    if python3 -c "import yaml" &>/dev/null; then
        return 0
    fi

    log_info "Python YAML module not found, installing..."
    local os
    os=$(detect_os)

    if [[ "$os" == "arch" ]]; then
        sudo pacman -S --noconfirm python-yaml || {
            log_error "Failed to install python-yaml"
            return 1
        }
    else
        sudo apt install -y python3-yaml || {
            log_error "Failed to install python3-yaml"
            return 1
        }
    fi

    if ! python3 -c "import yaml" &>/dev/null; then
        log_error "Failed to install Python YAML module"
        return 1
    fi
    log_success "Python YAML module installed"
}

# Get list of tool names from tools.yaml
get_tool_names() {
    python3 -c "$YAML_PARSER" "$TOOLS_FILE" list
}

# Get check command for a tool
get_check_command() {
    local tool="$1"
    python3 -c "$YAML_PARSER" "$TOOLS_FILE" check "$tool"
}

# Get install command for a tool and OS
get_install_command() {
    local tool="$1"
    local os="$2"
    python3 -c "$YAML_PARSER" "$TOOLS_FILE" install "$tool" "$os"
}

# ============================================================================
# Tool Installation
# ============================================================================

# Check if a tool is installed
is_tool_installed() {
    local check_cmd="$1"

    if [[ -z "$check_cmd" ]]; then
        return 1
    fi

    # Run check command, suppress output
    if eval "$check_cmd" &>/dev/null; then
        return 0
    else
        return 1
    fi
}

# Install a single tool
install_tool() {
    local tool="$1"
    local os="$2"
    local install_cmd

    install_cmd=$(get_install_command "$tool" "$os")

    if [[ -z "$install_cmd" ]]; then
        log_warn "No install command for $tool on $os"
        FAILED_TOOLS+=("$tool (no install command)")
        return 1
    fi

    log_install "$tool"

    # Run install command in a subshell to isolate environment changes
    if (eval "$install_cmd"); then
        log_success "$tool installed successfully"
        INSTALLED_TOOLS+=("$tool")
        return 0
    else
        log_error "Failed to install $tool"
        FAILED_TOOLS+=("$tool")
        return 1
    fi
}

# Process a single tool
process_tool() {
    local tool="$1"
    local os="$2"
    local check_cmd

    check_cmd=$(get_check_command "$tool")

    if is_tool_installed "$check_cmd"; then
        log_skip "$tool"
        SKIPPED_TOOLS+=("$tool")
    else
        install_tool "$tool" "$os" || true  # Don't fail on individual tool
    fi
}

# ============================================================================
# Summary
# ============================================================================

print_summary() {
    echo ""
    echo "============================================"
    echo "Tool Installation Summary"
    echo "============================================"

    if [[ ${#INSTALLED_TOOLS[@]} -gt 0 ]]; then
        echo -e "${GREEN}Installed (${#INSTALLED_TOOLS[@]}):${NC}"
        for tool in "${INSTALLED_TOOLS[@]}"; do
            echo "  + $tool"
        done
    fi

    if [[ ${#SKIPPED_TOOLS[@]} -gt 0 ]]; then
        echo -e "${BLUE}Already installed (${#SKIPPED_TOOLS[@]}):${NC}"
        for tool in "${SKIPPED_TOOLS[@]}"; do
            echo "  - $tool"
        done
    fi

    if [[ ${#FAILED_TOOLS[@]} -gt 0 ]]; then
        echo -e "${RED}Failed (${#FAILED_TOOLS[@]}):${NC}"
        for tool in "${FAILED_TOOLS[@]}"; do
            echo "  x $tool"
        done
    fi

    echo "============================================"

    if [[ ${#INSTALLED_TOOLS[@]} -gt 0 ]]; then
        echo ""
        echo "Note: You may need to restart your shell or run 'source ~/.bashrc'"
        echo "      (or ~/.zshrc) for PATH changes to take effect."
    fi
}

# ============================================================================
# Main
# ============================================================================

main() {
    log_info "Starting tool installation..."
    log_info "Reading configuration from: $TOOLS_FILE"

    # Check if tools file exists
    if [[ ! -f "$TOOLS_FILE" ]]; then
        log_error "Tools file not found: $TOOLS_FILE"
        exit 1
    fi

    # Detect OS
    local os
    os=$(detect_os)
    log_info "Detected OS: $os"

    # Ensure system dependencies are installed
    ensure_system_dependencies "$os" || {
        log_error "Failed to ensure system dependencies"
        exit 1
    }

    # Ensure Python YAML is available
    ensure_python_yaml || {
        log_error "Failed to ensure Python YAML support"
        exit 1
    }

    # Get list of tools
    local tools
    mapfile -t tools < <(get_tool_names)

    if [[ ${#tools[@]} -eq 0 ]]; then
        log_warn "No tools defined in $TOOLS_FILE"
        exit 0
    fi

    log_info "Found ${#tools[@]} tools to check"
    echo ""

    # Process each tool
    for tool in "${tools[@]}"; do
        process_tool "$tool" "$os"
    done

    # Print summary
    print_summary
}

main "$@"
